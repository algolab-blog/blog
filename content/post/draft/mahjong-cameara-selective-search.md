+++
authors = "kawahito"
date = "2016-08-17T15:28:18+09:00"
draft = true
tags = ["mahjong-camera", "image-recognition", "product"]
title = "麻雀カメラプロジェクト再始動？ 〜導入編〜"
+++

2014年の終わり頃に「麻雀カメラ」というiPhoneアプリを作っていました。  
カメラをかざすだけで麻雀の得点計算を行ってくれるアプリです。

{{<youtube "livDDcygEDU">}}

動画を見ていただければ一目瞭然ですが、さすがに実用では使えない、ということでお蔵入りしました...。  
(時間がかかるだけでなく、精度もあまり良くありませんでした。)  

あれから一年半、技術の進歩は目覚ましく、いまならば良いものが作れるのでは？と思い立ち、再挑戦してみることにしました。  
今回は、導入編として、当時用いていた手法について説明します。

## 画像判定プロセス
画像に何が写っているか判定するためには、大きく「検出 (Detection)」と「認識 (Recognition)」というプロセスに分かれます。

### 検出
物体が画像内のどこにあるかを判定するプロセス。  
下記の画像でいうと、赤枠をつけていくイメージです。

{{<img_rel "detection.png">}}

### 認識
検出された領域に写っている物体が何であるかを判定するプロセス。  
具体的には、下記の物体が「五萬」である、と分類することを言います。

{{<img_rel "recognition.png">}}

## 検出の難しさ
麻雀牌判定においては、特に「検出」のプロセスが困難です。  
横並びの複数牌に対し、どこが牌の境界かを判断することが非常に難しいのです。  
例えば、下記の画像を考えてみましょう。

{{<img_rel "detection_2.png">}}

人間の目には、3つの牌の境界を判断することはできますが、  
機械では、下記の赤枠の部分を1つの牌として検出してしまう、ということが起こり得てしまうのです。

{{<img_rel "detection_3.png">}}

牌の境界には溝らしきものが存在するので、画像処理で溝を判定し、境界とみなす、というような実装も考えられますが、光の具合などによって溝が見えなくなってしまうこともあるため、このような特定のルールを設ける方法ではうまくいきません。  

## テンプレートマッチング

以下のように、古典的な手法で判定を行っていました。

1. カメラの画像を二値化する
1. 二値化画像から、輪郭を抽出する
1. 抽出した輪郭を、頂点数や領域サイズの条件で絞りこむ
1. 絞りこんだ輪郭の外接矩形を手牌領域とみなす
1. 手牌領域に対し、テンプレートマッチングを行う
1. スコアが一番高い領域・牌を確定させる
1. 確定した箇所を除き、テンプレートマッチングを繰り返す
1. スコアが閾値を超えなくなったら終了
